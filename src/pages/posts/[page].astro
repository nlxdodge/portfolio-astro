---
import { getCollection } from "astro:content";
import Button from "../../components/Button.astro";
import Layout from "../../layouts/Layout.astro";
import Label from "../../components/Label.astro";

export async function getStaticPaths({ paginate }) {
  const posts = await getCollection("posts", ({ data }) => {
    return data.draft !== true;
  });
  const sortedPosts = posts.sort(
    (post) => Number.MIN_SAFE_INTEGER + post.data.date.getDate(),
  );
  return paginate(sortedPosts, {
    pageSize: 5,
  });
}

const { page } = Astro.props;
const posts = await getCollection("posts", ({ data }) => {
  return data.draft !== true;
});
const allTags = posts.flatMap((p) => p.data.tags);
let tagCounts = allTags.reduce((acc, tag) => {
  acc[tag] = (acc[tag] || 0) + 1;
  return acc;
}, {});
let sortedTags = allTags.sort((a, b) => tagCounts[b] - tagCounts[a]);
let uniqueTags = sortedTags.filter(
  (tag, index) => sortedTags.indexOf(tag) === index,
);
---

<Layout title="Posts | Gerben Veenhof">
  <h1 class="center-text">My Posts Collection 📝</h1>
  <div class="tags">
    {console.log("tags", uniqueTags.slice(0, 10))}
    {
      uniqueTags
        .slice(0, 5)
        .map((tag) => (
          <Label href={"/posts/" + tag.toLowerCase() + "/1"}>{tag}</Label>
        ))
    }
  </div>

  <div class="posts">
    {
      page.data.map((post) => (
        <div>
          <a class="post" href={`/post/${post.slug}`}>
            <h2>{post.data.title}</h2>
          </a>
          <p>{post.data.description}</p>
        </div>
      ))
    }
  </div>
  <div class="pagination">
    {
      page.url.prev ? (
        <Button
          href={page.url.prev}
          icon="mdi:arrow-back-circle"
          nofollow={false}
        >
          Previous
        </Button>
      ) : null
    }
    {
      page.url.next ? (
        <Button
          href={page.url.next}
          icon="mdi:arrow-forward-circle"
          nofollow={false}
          flipIcon={true}
        >
          Next
        </Button>
      ) : null
    }
  </div>
</Layout>

<style lang="scss">
  .tags {
    display: flex;
    justify-content: center;
    flex-wrap: wrap;
  }
</style>
